(()=>{function c(e,{variant:t="primary",delay:s=4e3}={}){let o=document.querySelector(".toast-container");if(!o){console.warn("[toast] Missing .toast-container");return}let n=document.createElement("div");n.className=`toast align-items-center text-bg-${t} border-0`,n.role="alert",n.ariaLive="assertive",n.ariaAtomic="true",n.innerHTML=`<div class="d-flex"><div class="toast-body">${e}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`,o.appendChild(n),window.bootstrap&&window.bootstrap.Toast&&(new window.bootstrap.Toast(n,{autohide:!0,delay:s}).show(),n.addEventListener("hidden.bs.toast",()=>n.remove()))}function d(e,t=document){return t.querySelector(e)}function l(){let e=document.getElementById("loadingSpinner");e&&e.classList.remove("d-none","fade")}function u(){let e=document.getElementById("loadingSpinner");e&&(e.classList.add("fade"),setTimeout(()=>{e.classList.add("d-none")},150))}function m(e){let t=document.createElement("tr");return t.dataset.code2=e.country_code2,t.innerHTML=`
    <td class="align-middle">${p(e.country_code2)}</td>
    <td><code>${e.country_code2}</code></td>
    <td>
      <input type="text" class="form-control form-control-sm code3-input" value="${e.country_code3||""}" maxlength="3" />
    </td>
    <td>
      <input type="text" class="form-control form-control-sm name-input" value="${e.name||""}" />
    </td>
    <td style="max-width:120px">
      <input type="number" class="form-control form-control-sm score-input" value="${Number(e.score)||0}" step="1" />
    </td>
    <td class="text-end">
      <button class="btn btn-sm btn-primary save-btn"><i class="bi bi-save"></i> Save</button>
    </td>
  `,t.querySelector(".save-btn").addEventListener("click",async()=>{await b(t)}),t}function p(e){return!e||e==="??"?'<span class="text-muted">&mdash;</span>':`<img src="/flags/${e.toLowerCase()}.svg" loading="lazy" alt="${e} flag" class="country-flag" style="width:24px;height:18px;object-fit:cover;border:1px solid #dee2e6;border-radius:2px;background:#fff" onerror="this.replaceWith(document.createElement('span'))">`}async function f(){let e=await fetch("/api/v3/countries",{credentials:"same-origin"});if(!e.ok)throw new Error(`${e.status} ${e.statusText}`);return e.json()}function y(e){let t=(d("#searchInput").value||"").trim().toLowerCase(),s=d("#scoreFilter").value,o=e;return t&&(o=o.filter(n=>n.name.toLowerCase().includes(t)||(n.country_code2||"").toLowerCase().includes(t)||(n.country_code3||"").toLowerCase().includes(t))),s==="neg"&&(o=o.filter(n=>Number(n.score)<0)),s==="zero"&&(o=o.filter(n=>Number(n.score)===0)),s==="pos"&&(o=o.filter(n=>Number(n.score)>0)),o}async function b(e){let t=e.dataset.code2,s=e.querySelector(".name-input").value.trim(),o=e.querySelector(".code3-input").value.trim().toUpperCase(),n=Number(e.querySelector(".score-input").value),i=e.querySelector(".save-btn");try{i.disabled=!0,l();let r=await fetch(`/api/v3/countries/${encodeURIComponent(t)}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({name:s,score:n,country_code3:o})});if(!r.ok)throw new Error(`${r.status} ${r.statusText}`);c("Saved",{variant:"success"})}catch(r){console.error(r),c(`Save failed: ${r.message}`,{variant:"danger"})}finally{i.disabled=!1,u()}}function a(e){let t=document.getElementById("countriesTbody");t.innerHTML="";let s=y(e);if(s.length===0){let o=document.createElement("tr");o.innerHTML='<td colspan="6" class="text-muted">No results</td>',t.appendChild(o)}else s.forEach(o=>t.appendChild(m(o)));document.getElementById("countSummary").textContent=`${s.length} / ${e.length}`}async function v(){!window.assertBootstrapReady||window.assertBootstrapReady("admin-countries");try{l();let e=await f(),t=Array.isArray(e)?e:[];a(t),document.getElementById("filterForm").addEventListener("submit",s=>{s.preventDefault(),a(t)}),document.getElementById("searchInput").addEventListener("input",()=>a(t)),document.getElementById("scoreFilter").addEventListener("change",()=>a(t))}catch(e){console.error(e);let t=document.getElementById("countriesTbody");t.innerHTML=`<tr><td colspan="5" class="text-danger">Failed to load: ${e.message}</td></tr>`}finally{u()}}document.addEventListener("DOMContentLoaded",v);})();
