(()=>{document.addEventListener("DOMContentLoaded",()=>{typeof window.assertBootstrapReady=="function"&&window.assertBootstrapReady("admin-users");let d=document.getElementById("usersTableBody"),w=document.getElementById("pagination"),k=document.getElementById("searchForm"),C=document.getElementById("emailSearchInput"),c=document.getElementById("userModal"),f=null;c&&window.bootstrap&&(f=window.bootstrap.Modal.getOrCreateInstance(c));let L=c.querySelector(".modal-title"),I=document.getElementById("userForm"),g=document.getElementById("emailInput"),p=document.getElementById("statusInput"),b=document.getElementById("userIdInput"),l=document.getElementById("rolesCheckboxes"),M=document.querySelector(".toast-container"),E=document.getElementById("loadingSpinner"),a=1,u="",v=[],i=(s,e="success")=>{let t=document.createElement("div");t.className=`toast align-items-center text-white bg-${e} border-0`,t.role="alert",t.ariaLive="assertive",t.ariaAtomic="true",t.innerHTML=`
      <div class="d-flex">
        <div class="toast-body">${s}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `,M.appendChild(t),window.bootstrap&&(new window.bootstrap.Toast(t,{autohide:!0,delay:5e3}).show(),t.addEventListener("hidden.bs.toast",()=>t.remove()))},$=()=>{E.classList.remove("d-none","fade")},x=()=>{E.classList.add("fade"),setTimeout(()=>{E.classList.add("d-none")},150)},m=async(s=1,e="")=>{$();try{d.innerHTML.includes("text-muted")&&(d.innerHTML="");let t=new URLSearchParams({page:s,limit:10,email:e}),n=await fetch(`/api/v3/users?${t}`);if(!n.ok)throw new Error("Failed to fetch users");let r=await n.json();B(r.users),S(r.pagination)}catch(t){console.error("Error fetching users:",t),d.innerHTML='<tr><td colspan="4" class="text-danger">Error loading users.</td></tr>'}finally{x()}},B=s=>{if(d.innerHTML="",!s||s.length===0){d.innerHTML='<tr><td colspan="4" class="text-muted">No users found.</td></tr>';return}s.forEach(e=>{let t=document.createElement("tr");t.innerHTML=`
        <td>${e.email}</td>
        <td>${e.roles&&e.roles.length>0?e.roles.join(", "):"N/A"}</td>
        <td>${e.status}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#userModal" data-user-id="${e.id}" title="Edit user">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" data-delete-user data-user-id="${e.id}" title="Delete user">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `,d.appendChild(t)})},S=s=>{if(w.innerHTML="",!(!s||s.totalPages<=1))for(let e=1;e<=s.totalPages;e++){let t=document.createElement("li");t.className=`page-item ${e===s.currentPage?"active":""}`;let n=document.createElement("a");n.className="page-link",n.href="#",n.textContent=e,n.addEventListener("click",r=>{r.preventDefault(),a=e,m(a,u)}),t.appendChild(n),w.appendChild(t)}};k.addEventListener("submit",s=>{s.preventDefault(),u=C.value.trim(),a=1,m(a,u)});let H=async()=>{try{let s=await fetch("/api/v3/user-statuses");if(s.ok){let e=await s.json();p.innerHTML="",e.forEach(t=>{let n=document.createElement("option");n.value=t.slug,n.textContent=t.title,p.appendChild(n)})}}catch(s){console.error("Error fetching user statuses:",s)}},A=async()=>{try{let s=await fetch("/api/v3/roles");s.ok&&(v=await s.json())}catch(s){console.error("Error fetching roles:",s)}},T=(s=[])=>{l.innerHTML="",v.forEach(e=>{let t=s.includes(e.name),n=e.name==="user",r=document.createElement("div");r.className="form-check",r.innerHTML=`
        <input class="form-check-input" type="checkbox" value="${e.id}" id="role-${e.id}" name="roles" ${t?"checked":""} ${n?"disabled":""}>
        <label class="form-check-label" for="role-${e.id}">${e.name}</label>
      `,l.appendChild(r)})};c.addEventListener("show.bs.modal",async s=>{let t=s.relatedTarget.getAttribute("data-user-id");if(I.reset(),l.innerHTML="Loading roles...",t){L.textContent="Edit User",b.value=t;try{let n=await fetch(`/api/v3/users/${t}`);if(!n.ok)throw new Error("Failed to fetch user details");let r=await n.json();g.value=r.email,p.value=r.status_slug,T(r.roles)}catch(n){console.error("Error fetching user details:",n),l.innerHTML='<p class="text-danger">Could not load roles.</p>'}}else L.textContent="Create User",b.value="",T(["user"])}),c.addEventListener("shown.bs.modal",()=>{g.focus()}),I.addEventListener("submit",async s=>{s.preventDefault();let e=b.value,t=e?`/api/v3/users/${e}`:"/api/v3/users",n=e?"PUT":"POST",r=Array.from(l.querySelectorAll('input[name="roles"]:checked')).map(o=>parseInt(o.value,10)),y=v.find(o=>o.name==="user");y&&!r.includes(y.id)&&r.push(y.id);let U={email:g.value,status:p.value,roles:r};try{let o=await fetch(t,{method:n,headers:{"Content-Type":"application/json"},body:JSON.stringify(U)});if(o.ok)c.addEventListener("hidden.bs.modal",()=>{let h=document.querySelector(".modal-backdrop");h&&h.remove(),i("User saved successfully."),m(a,u)},{once:!0}),f&&f.hide();else{let h=await o.json().catch(()=>({message:"Error saving user"}));i(h.message||"Error saving user","danger")}}catch(o){console.error("Error saving user:",o),i("An unexpected error occurred.","danger")}}),document.body.addEventListener("click",async s=>{let e=s.target.closest("[data-delete-user]");if(e&&confirm("Are you sure you want to delete this user?")){let t=e.getAttribute("data-user-id");try{(await fetch(`/api/v3/users/${t}`,{method:"DELETE"})).ok?(i("User deleted successfully."),m(a,u)):i("Error deleting user.","danger")}catch(n){console.error("Error deleting user:",n),i("An unexpected error occurred.","danger")}}}),H(),A().then(()=>{m(a)})});})();
