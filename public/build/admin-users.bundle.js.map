{
  "version": 3,
  "sources": ["../js/admin-users.js"],
  "sourcesContent": ["document.addEventListener('DOMContentLoaded', () => {\n  if (typeof window.assertBootstrapReady === 'function') {\n    window.assertBootstrapReady('admin-users');\n  }\n  const usersTableBody = document.getElementById('usersTableBody');\n  const paginationUl = document.getElementById('pagination');\n  const searchForm = document.getElementById('searchForm');\n  const emailSearchInput = document.getElementById('emailSearchInput');\n  const userModalEl = document.getElementById('userModal');\n\n  let userModal = null;\n  if (userModalEl && window.bootstrap) {\n    userModal = window.bootstrap.Modal.getOrCreateInstance(userModalEl);\n  }\n\n  const modalTitle = userModalEl.querySelector('.modal-title');\n  const userForm = document.getElementById('userForm');\n  const emailInput = document.getElementById('emailInput');\n  const statusInput = document.getElementById('statusInput');\n  const userIdInput = document.getElementById('userIdInput');\n  const rolesCheckboxes = document.getElementById('rolesCheckboxes');\n  const toastContainer = document.querySelector('.toast-container');\n  const loadingSpinner = document.getElementById('loadingSpinner');\n\n  let currentPage = 1;\n  let currentSearchTerm = '';\n  let allRoles = [];\n\n  const showToast = (message, type = 'success') => {\n    const toastEl = document.createElement('div');\n    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;\n    toastEl.role = 'alert';\n    toastEl.ariaLive = 'assertive';\n    toastEl.ariaAtomic = 'true';\n    toastEl.innerHTML = `\n      <div class=\"d-flex\">\n        <div class=\"toast-body\">${message}</div>\n        <button type=\"button\" class=\"btn-close btn-close-white me-2 m-auto\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button>\n      </div>\n    `;\n    toastContainer.appendChild(toastEl);\n    if (window.bootstrap) {\n      const toast = new window.bootstrap.Toast(toastEl, { autohide: true, delay: 5000 });\n      toast.show();\n      toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());\n    }\n  };\n\n  const showLoadingSpinner = () => {\n    loadingSpinner.classList.remove('d-none', 'fade');\n  };\n\n  const hideLoadingSpinner = () => {\n    loadingSpinner.classList.add('fade');\n    setTimeout(() => {\n      loadingSpinner.classList.add('d-none');\n    }, 150); // Match Bootstrap's fade duration\n  };\n\n  const fetchUsers = async (page = 1, email = '') => {\n    showLoadingSpinner();\n    try {\n      // Keep the table body empty while loading, but don't show a spinner in it\n      if (usersTableBody.innerHTML.includes('text-muted')) {\n        usersTableBody.innerHTML = '';\n      }\n      const params = new URLSearchParams({ page, limit: 10, email });\n      const response = await fetch(`/api/v3/users?${params}`);\n      if (!response.ok) {\n        throw new Error('Failed to fetch users');\n      }\n      const data = await response.json();\n      renderUsers(data.users);\n      renderPagination(data.pagination);\n    } catch (error) {\n      console.error('Error fetching users:', error);\n      usersTableBody.innerHTML = `<tr><td colspan=\"4\" class=\"text-danger\">Error loading users.</td></tr>`;\n    } finally {\n      hideLoadingSpinner();\n    }\n  };\n\n  const renderUsers = (users) => {\n    usersTableBody.innerHTML = '';\n    if (!users || users.length === 0) {\n      usersTableBody.innerHTML = `<tr><td colspan=\"4\" class=\"text-muted\">No users found.</td></tr>`;\n      return;\n    }\n    users.forEach((user) => {\n      const row = document.createElement('tr');\n      row.innerHTML = `\n        <td>${user.email}</td>\n        <td>${user.roles && user.roles.length > 0 ? user.roles.join(', ') : 'N/A'}</td>\n        <td>${user.status}</td>\n        <td class=\"text-end\">\n          <button class=\"btn btn-sm btn-outline-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#userModal\" data-user-id=\"${user.id}\" title=\"Edit user\">\n            <i class=\"bi bi-pencil-square\"></i>\n          </button>\n          <button class=\"btn btn-sm btn-outline-danger\" data-delete-user data-user-id=\"${user.id}\" title=\"Delete user\">\n            <i class=\"bi bi-trash\"></i>\n          </button>\n        </td>\n      `;\n      usersTableBody.appendChild(row);\n    });\n  };\n\n  const renderPagination = (pagination) => {\n    paginationUl.innerHTML = '';\n    if (!pagination || pagination.totalPages <= 1) {\n      return;\n    }\n    for (let i = 1; i <= pagination.totalPages; i++) {\n      const li = document.createElement('li');\n      li.className = `page-item ${i === pagination.currentPage ? 'active' : ''}`;\n      const a = document.createElement('a');\n      a.className = 'page-link';\n      a.href = '#';\n      a.textContent = i;\n      a.addEventListener('click', (e) => {\n        e.preventDefault();\n        currentPage = i;\n        fetchUsers(currentPage, currentSearchTerm);\n      });\n      li.appendChild(a);\n      paginationUl.appendChild(li);\n    }\n  };\n\n  searchForm.addEventListener('submit', (e) => {\n    e.preventDefault();\n    currentSearchTerm = emailSearchInput.value.trim();\n    currentPage = 1;\n    fetchUsers(currentPage, currentSearchTerm);\n  });\n\n  const populateStatuses = async () => {\n    try {\n      const response = await fetch('/api/v3/user-statuses');\n      if (response.ok) {\n        const statuses = await response.json();\n        statusInput.innerHTML = ''; // Clear previous options\n        statuses.forEach((status) => {\n          const option = document.createElement('option');\n          option.value = status.slug;\n          option.textContent = status.title;\n          statusInput.appendChild(option);\n        });\n      }\n    } catch (error) {\n      console.error('Error fetching user statuses:', error);\n    }\n  };\n\n  const populateRoles = async () => {\n    try {\n      const response = await fetch('/api/v3/roles');\n      if (response.ok) {\n        allRoles = await response.json();\n      }\n    } catch (error) {\n      console.error('Error fetching roles:', error);\n    }\n  };\n\n  const renderRoles = (userRoles = []) => {\n    rolesCheckboxes.innerHTML = '';\n    allRoles.forEach((role) => {\n      const isChecked = userRoles.includes(role.name);\n      const isDisabled = role.name === 'user';\n      const div = document.createElement('div');\n      div.className = 'form-check';\n      div.innerHTML = `\n        <input class=\"form-check-input\" type=\"checkbox\" value=\"${role.id}\" id=\"role-${role.id}\" name=\"roles\" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>\n        <label class=\"form-check-label\" for=\"role-${role.id}\">${role.name}</label>\n      `;\n      rolesCheckboxes.appendChild(div);\n    });\n  };\n\n  userModalEl.addEventListener('show.bs.modal', async (event) => {\n    const button = event.relatedTarget;\n    const userId = button.getAttribute('data-user-id');\n    userForm.reset();\n    rolesCheckboxes.innerHTML = 'Loading roles...';\n\n    if (userId) {\n      modalTitle.textContent = 'Edit User';\n      userIdInput.value = userId;\n      try {\n        const response = await fetch(`/api/v3/users/${userId}`);\n        if (!response.ok) {\n          throw new Error('Failed to fetch user details');\n        }\n        const user = await response.json();\n        emailInput.value = user.email;\n        statusInput.value = user.status_slug;\n        renderRoles(user.roles);\n      } catch (error) {\n        console.error('Error fetching user details:', error);\n        rolesCheckboxes.innerHTML = '<p class=\"text-danger\">Could not load roles.</p>';\n      }\n    } else {\n      modalTitle.textContent = 'Create User';\n      userIdInput.value = '';\n      renderRoles(['user']);\n    }\n  });\n\n  userModalEl.addEventListener('shown.bs.modal', () => {\n    emailInput.focus();\n  });\n\n  userForm.addEventListener('submit', async (event) => {\n    event.preventDefault();\n    const id = userIdInput.value;\n    const url = id ? `/api/v3/users/${id}` : '/api/v3/users';\n    const method = id ? 'PUT' : 'POST';\n\n    const selectedRoles = Array.from(\n      rolesCheckboxes.querySelectorAll('input[name=\"roles\"]:checked')\n    ).map((input) => parseInt(input.value, 10));\n    const userRole = allRoles.find((r) => r.name === 'user');\n    if (userRole && !selectedRoles.includes(userRole.id)) {\n      selectedRoles.push(userRole.id);\n    }\n\n    const data = {\n      email: emailInput.value,\n      status: statusInput.value,\n      roles: selectedRoles\n    };\n\n    try {\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data)\n      });\n      if (response.ok) {\n        // Wait for the modal to be fully hidden before showing the toast and refreshing the table\n        // This prevents issues with the modal backdrop not being removed correctly.\n        userModalEl.addEventListener(\n          'hidden.bs.modal',\n          () => {\n            // Manually remove the backdrop in case it lingers\n            const backdrop = document.querySelector('.modal-backdrop');\n            if (backdrop) {\n              backdrop.remove();\n            }\n            showToast('User saved successfully.');\n            fetchUsers(currentPage, currentSearchTerm);\n          },\n          { once: true }\n        );\n\n        if (userModal) {\n          userModal.hide();\n        }\n      } else {\n        const errorData = await response.json().catch(() => ({ message: 'Error saving user' }));\n        showToast(errorData.message || 'Error saving user', 'danger');\n      }\n    } catch (error) {\n      console.error('Error saving user:', error);\n      showToast('An unexpected error occurred.', 'danger');\n    }\n  });\n\n  document.body.addEventListener('click', async (event) => {\n    const button = event.target.closest('[data-delete-user]');\n    if (button) {\n      if (confirm('Are you sure you want to delete this user?')) {\n        const userId = button.getAttribute('data-user-id');\n        try {\n          const response = await fetch(`/api/v3/users/${userId}`, { method: 'DELETE' });\n          if (response.ok) {\n            showToast('User deleted successfully.');\n            fetchUsers(currentPage, currentSearchTerm);\n          } else {\n            showToast('Error deleting user.', 'danger');\n          }\n        } catch (error) {\n          console.error('Error deleting user:', error);\n          showToast('An unexpected error occurred.', 'danger');\n        }\n      }\n    }\n  });\n\n  // Initial fetches\n  populateStatuses();\n  populateRoles().then(() => {\n    fetchUsers(currentPage);\n  });\n});\n"],
  "mappings": "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",
  "names": []
}
