{
  "version": 3,
  "sources": ["../js/messages.js"],
  "sourcesContent": ["/* Dashboard - User Messages */\n// Tiny helpers (local to this bundle)\nasync function fetchJson(url, opts = {}) {\n  const res = await fetch(url, { credentials: 'same-origin', ...opts });\n  if (!res.ok) {\n    const text = await res.text().catch(() => '');\n    throw new Error(`${res.status} ${res.statusText} ${text}`.trim());\n  }\n  return res.json();\n}\nfunction escapeHtml(str) {\n  return String(str)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n}\nfunction html(strings, ...values) {\n  return strings.reduce((out, s, i) => out + s + (i < values.length ? String(values[i]) : ''), '');\n}\n\nconst state = {\n  page: 1,\n  pageSize: 10,\n  q: ''\n};\n\nfunction flagEmoji(countryCode) {\n  if (!countryCode) return '';\n  const code = countryCode.trim().toUpperCase();\n  if (!/^[A-Z]{2}$/.test(code)) return '';\n  return code\n    .split('')\n    .map((c) => String.fromCodePoint(0x1f1e6 - 65 + c.charCodeAt(0)))\n    .join('');\n}\n\nfunction badge(key, value) {\n  const content = value == null ? '' : String(value);\n  if (!content) return '';\n  return `<span class=\"badge text-bg-secondary me-1\">${escapeHtml(key)}: ${escapeHtml(content)}</span>`;\n}\n\nfunction renderCard(row) {\n  const ip = row.sender_ip || '';\n  const country = row.sender_country || '';\n  const ttr = Number(row.time_to_result) || 0;\n  let fields = '';\n  try {\n    const mf =\n      typeof row.message_fields === 'string' ? JSON.parse(row.message_fields) : row.message_fields;\n    if (mf && typeof mf === 'object') {\n      for (const [k, v] of Object.entries(mf)) {\n        fields += badge(k, v);\n      }\n    }\n  } catch (e) {\n    // ignore bad JSON\n  }\n  const headerBits = [];\n  if (ip) headerBits.push(`<span title=\"Sender IP\">${escapeHtml(ip)}</span>`);\n  if (country)\n    headerBits.push(`<span title=\"Country\">${flagEmoji(country)} ${escapeHtml(country)}</span>`);\n  const header = headerBits.join(' \u00B7 ');\n\n  const body = escapeHtml(row.message_body || '');\n  const when = row.event_time ? new Date(row.event_time).toLocaleString() : '';\n  const resultBadge = row.is_spam\n    ? '<span class=\"badge text-bg-danger\">Spam</span>'\n    : row.is_ham\n      ? '<span class=\"badge text-bg-success\">Ham</span>'\n      : '';\n\n  return html` <div class=\"col-12\">\n    <div class=\"card h-100\">\n      <div class=\"card-header d-flex justify-content-between align-items-center\">\n        <div class=\"d-flex align-items-center gap-2\">\n          ${resultBadge}\n          <span>${header || '<span class=\"text-muted\">Unknown sender</span>'}</span>\n        </div>\n        <div>${fields}</div>\n      </div>\n      <div class=\"card-body\">\n        <pre class=\"mb-0\" style=\"white-space: pre-wrap;\">${body}</pre>\n      </div>\n      <div class=\"card-footer d-flex justify-content-between align-items-center small text-muted\">\n        <span>${when}</span>\n        <span title=\"Classification time\">${ttr} ms</span>\n      </div>\n    </div>\n  </div>`;\n}\n\nfunction renderPagination(p) {\n  const ul = document.getElementById('messagesPagination');\n  ul.innerHTML = '';\n  const { currentPage, totalPages } = p;\n  function li(page, label, disabled = false, active = false) {\n    const li = document.createElement('li');\n    li.className = `page-item${disabled ? ' disabled' : ''}${active ? ' active' : ''}`;\n    const a = document.createElement('a');\n    a.className = 'page-link';\n    a.href = '#';\n    a.textContent = label;\n    a.addEventListener('click', (e) => {\n      e.preventDefault();\n      if (disabled || active) return;\n      state.page = page;\n      load();\n    });\n    li.appendChild(a);\n    ul.appendChild(li);\n  }\n  li(Math.max(1, currentPage - 1), 'Prev', currentPage <= 1);\n  for (let i = 1; i <= totalPages; i++) {\n    li(i, String(i), false, i === currentPage);\n  }\n  li(Math.min(totalPages, currentPage + 1), 'Next', currentPage >= totalPages);\n}\n\nasync function load() {\n  const status = document.getElementById('messagesStatus');\n  const list = document.getElementById('messagesList');\n  status.textContent = 'Loading\u2026';\n  list.innerHTML = '';\n\n  const params = new URLSearchParams();\n  params.set('page', String(state.page));\n  params.set('pageSize', String(state.pageSize));\n  if (state.q) params.set('q', state.q);\n\n  try {\n    const data = await fetchJson(`/api/dash/messages?${params.toString()}`);\n    const { items, pagination } = data;\n    if (!items || items.length === 0) {\n      status.textContent = 'No messages found';\n      renderPagination(pagination);\n      return;\n    }\n    status.textContent = `${pagination.total} total, page ${pagination.currentPage} of ${pagination.totalPages}`;\n    list.innerHTML = items.map(renderCard).join('');\n    renderPagination(pagination);\n  } catch (err) {\n    status.textContent = 'Failed to load messages';\n    console.error(err);\n  }\n}\n\nfunction bindSearch() {\n  const form = document.getElementById('searchForm');\n  const input = document.getElementById('searchQuery');\n  const clear = document.getElementById('clearSearch');\n  form.addEventListener('submit', (e) => {\n    e.preventDefault();\n    state.q = input.value.trim();\n    state.page = 1;\n    load();\n  });\n  clear.addEventListener('click', () => {\n    input.value = '';\n    state.q = '';\n    state.page = 1;\n    load();\n  });\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  bindSearch();\n  load();\n});\n"],
  "mappings": "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",
  "names": ["li"]
}
